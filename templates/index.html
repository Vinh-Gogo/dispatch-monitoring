<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Kitchen Observer</title>
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="header">
    </div>
    <div class="main-content">
      <div class="video-section">
        <div class="section-header">
          <h3>Video Feed</h3>
          <p>Upload a video to begin analysis. The system supports common formats like MP4.</p>
        </div>
        <div class="video-container">
          <div id="drop-area" class="drop-area">
            <input type="file" id="video-input" accept="video/mp4" style="display: none;">
            <label for="video-input" class="upload-button">
                <span class="material-icons">cloud_upload</span> Upload Video
            </label>
            <div class="no-video-uploaded" id="no-video-message">
              <span class="material-icons camera-icon">videocam</span>
              <p>No video uploaded</p>
              <p>Click the button above to select a video file.</p>
            </div>
            <video id="video-preview" controls muted loop style="display: none; width: 100%; height: 100%; object-fit: contain;"></video>
          </div>
        </div>
      </div>

      <div class="ai-analysis-section">
        <div class="section-header">
          <h3><span class="material-icons">auto_awesome</span> AI Analysis</h3>
          <p>Results from the AI models will appear here after processing.</p>
        </div>
        <div class="card">
          <h4><span class="material-icons">summarize</span> Predict</h4>
          <p>Result predict frame current from video</p>
          <div class="summary-output" id="detected-videos-output">
            <p id="analysis-status">Upload a video to start processing...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="manual-review-section">
      <div class="section-header">
        <h3>Manual Review</h3>
        <p>Confirm the AI's findings to help improve the system. Your feedback is valuable.</p>
      </div>
      <div class="feedback-buttons">
        <button class="confirm-button success"><span class="material-icons">check_circle</span> Confirm: Has Food</button>
        <button class="confirm-button danger"><span class="material-icons">cancel</span> Confirm: No Food</button>
      </div>
    </div>
  </div>

  <script>
    const dropArea = document.getElementById('drop-area');
    const videoInput = document.getElementById('video-input');
    const videoPreview = document.getElementById('video-preview');
    const noVideoMessage = document.getElementById('no-video-message');
    const uploadButton = document.querySelector('.upload-button');
    const analysisStatus = document.getElementById('analysis-status'); 

    let selectedVideoFile = null;
    let currentVideoObjectUrl = null; // To keep track of the current ObjectURL to revoke later

    // Helper function to revoke ObjectURL to free up memory
    function revokeCurrentVideoURL() {
      if (currentVideoObjectUrl) {
        URL.revokeObjectURL(currentVideoObjectUrl);
        currentVideoObjectUrl = null;
        console.log("Frontend: Revoked previous ObjectURL.");
      }
    }

    videoInput.addEventListener('change', () => {
      const file = videoInput.files[0];
      if (file) {
        selectedVideoFile = file;
        console.log("Frontend: File selected:", file.name);
        // Revoke any previous URL before setting a new one
        revokeCurrentVideoURL();
        displayOriginalVideo(file); 
        processAndStreamVideo(file); 
      }
    });

    dropArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropArea.classList.add('drag-over');
    });

    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('drag-over');
    });

    dropArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dropArea.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('video/')) {
        selectedVideoFile = file;
        console.log("Frontend: File dropped:", file.name);
        revokeCurrentVideoURL();
        displayOriginalVideo(file);
        processAndStreamVideo(file);
      } else {
        alert('Please drop a video file (MP4).');
      }
    });

    // Displays the original video in the preview area
    function displayOriginalVideo(file) {
      console.log("Frontend: Displaying original video.");
      currentVideoObjectUrl = URL.createObjectURL(file);
      videoPreview.src = currentVideoObjectUrl;
      videoPreview.style.display = 'block';
      noVideoMessage.style.display = 'none';
      uploadButton.style.display = 'none';
      videoPreview.load(); // Explicitly load the new source
      videoPreview.play().catch(e => {
        console.warn("Frontend: Autoplay of original video failed (this is common):", e);
      });
    }

    async function processAndStreamVideo(file) {
      if (!file) return;

      analysisStatus.textContent = "Processing video on server. Please wait...";
      // Pause and reset original video if it's currently playing and you want to ensure it stops.
      videoPreview.pause(); 
      videoPreview.currentTime = 0; 

      const formData = new FormData();
      formData.append("file", file);

      try {
        console.log("Frontend: Sending video to /process_video/ endpoint...");
        const response = await fetch("/process_video/", { 
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error("Frontend: Error processing video (Server response not OK):", response.status, errorText);
          analysisStatus.textContent = `Error processing video: ${errorText}`;
          alert(`Error processing video: ${response.status} - ${errorText}. Check console.`);
          return;
        }

        console.log("Frontend: Received successful response from /process_video/. Getting blob...");
        const processedVideoBlob = await response.blob();
        
        // Revoke the URL of the original video before setting the new one
        revokeCurrentVideoURL(); 

        currentVideoObjectUrl = URL.createObjectURL(processedVideoBlob);
        console.log("Frontend: Created ObjectURL for processed video:", currentVideoObjectUrl);
        
        // Update the video source to the processed video
        videoPreview.src = currentVideoObjectUrl;
        videoPreview.load(); // Tell the video element to load the new source

        // Play the processed video
        videoPreview.onloadeddata = () => { // Use 'loadeddata' or 'canplaythrough' for better reliability
            console.log("Frontend: Processed video data loaded. Attempting to play...");
            videoPreview.play().then(() => {
                console.log("Frontend: Processed video playing successfully.");
                analysisStatus.textContent = "Video processing complete! Playing annotated video.";
            }).catch(e => {
                console.error("Frontend: Autoplay of processed video failed:", e);
                analysisStatus.textContent = "Video processing complete! Please click the play button on the video.";
            });
        };
        // Fallback if 'loadeddata' already fired (e.g., cached or very fast)
        if (videoPreview.readyState >= videoPreview.HAVE_ENOUGH_DATA) { // Ensure enough data to play
            videoPreview.onloadeddata(); // Manually trigger the play logic
        }
        
      } catch (error) {
        console.error("Frontend: Network or fetch error during video processing:", error);
        analysisStatus.textContent = "Error during video processing. Check console for details.";
        alert("Error during video processing. Check console for details.");
      }
    }
  </script>
</body>
</html>